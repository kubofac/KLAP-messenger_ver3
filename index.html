<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

    <title>KLAP_messenger</title>
    <style>
        /* CSSはサインボードの要件を維持（背景黒、文字白、巨大フォント） */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000000;
            margin: 0; 
            padding: 0; 
            color: #ffffff;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow: hidden;
            text-align: center;
        }
        
        .message-container { 
            width: 90vw; /* 画面幅の90%を使用 */
            height: 90vh; /* 画面高さの90%を使用 */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
        }

        #message-display { 
            /* 初期フォントサイズはビューポート単位で巨大に */
            font-size: 15vw; 
            color: #ffffff; 
            word-break: break-word; 
            white-space: pre-wrap; 
            font-weight: 900; 
            line-height: 1.1;
            transition: color 0.3s ease;
        }
        
        /* 更新時のフィードバック */
        .updated { 
            color: #79f291 !important; /* 明るい緑色に点滅 */
        } 
        
        /* 接続状態のインジケータ */
        #status {
            position: fixed;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
<div class="message-container" id="msg-box">
    <!-- メッセージ本体 -->
    <div id="message-display">接続中...</div>
    <div id="status">ステータス: 未接続</div>
</div>

<script>
    // --- 【重要】ESP32のIPアドレスを設定してください ---
    // SoftAPのデフォルトIPアドレスは 192.168.4.1 です。
    const ESP32_IP = "192.168.4.1";
    const API_URL = `http://${ESP32_IP}/message`; 
    // --------------------------------------------------

    let lastMessage = ""; 
    const messageDisplay = document.getElementById('message-display');
    const msgBox = document.getElementById('msg-box');
    const statusDisplay = document.getElementById('status');

    // フォントサイズを動的に調整する関数
    function adjustFontSize() {
        const containerWidth = msgBox.clientWidth - 20; 
        const containerHeight = msgBox.clientHeight - 20; 
        
        messageDisplay.style.fontSize = '100px'; 
        
        let fontSize = 100;
        
        while (messageDisplay.scrollWidth > containerWidth || messageDisplay.scrollHeight > containerHeight) {
            fontSize -= 1;
            if (fontSize < 10) break;
            messageDisplay.style.fontSize = fontSize + 'px';
        }

        messageDisplay.style.fontSize = fontSize + 'px';
    }

    // 最新メッセージを取得する関数
    function fetchMessage() {
        statusDisplay.textContent = 'ステータス: ポーリング中...';
        
        fetch(API_URL)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                statusDisplay.textContent = 'ステータス: 接続済み';
                
                if (data !== lastMessage) {
                    messageDisplay.textContent = data;
                    lastMessage = data;
                    
                    adjustFontSize();
                    
                    // 更新フィードバック
                    msgBox.classList.add('updated');
                    setTimeout(() => {
                        msgBox.classList.remove('updated');
                    }, 500);
                }
            })
            .catch(error => {
                console.error('メッセージ取得エラー:', error);
                statusDisplay.textContent = 'ステータス: ❌ 接続エラー (IP確認)';
                messageDisplay.textContent = '❌ エラーが発生しました。IPアドレスを確認してください。';
                adjustFontSize();
            });
    }

    // ページロード時の初期設定
    window.onload = function() {
        // 画面全体を使用するようにbody/htmlの高さも設定
        document.documentElement.style.height = '100%';
        document.body.style.height = '100%';
        
        fetchMessage(); // ページロード時に即座に取得
        
        // 1秒ごとにポーリング
        setInterval(fetchMessage, 1000); 

        // 画面リサイズ時にフォントサイズを再調整
        window.addEventListener('resize', adjustFontSize);
    };
</script>

</body>
</html>
