<!DOCTYPE html>
<html lang="ja">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <!-- PWAãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‚ç…§ -->
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â Â 
Â  Â  <title>KLAP Signboard Receiver</title>
Â  Â  <style>
Â  Â  Â  Â  /* CSSã¯ã‚µã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ã®è¦ä»¶ã‚’ç¶­æŒï¼ˆèƒŒæ™¯é»’ã€æ–‡å­—ç™½ã€å·¨å¤§ãƒ•ã‚©ãƒ³ãƒˆï¼‰ */
Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;Â 
Â  Â  Â  Â  Â  Â  background-color: #000000;
Â  Â  Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  color: #ffffff;
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  min-height: 100vh;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .message-container {Â 
Â  Â  Â  Â  Â  Â  width: 90vw; /* ç”»é¢å¹…ã®90%ã‚’ä½¿ç”¨ */
Â  Â  Â  Â  Â  Â  height: 90vh; /* ç”»é¢é«˜ã•ã®90%ã‚’ä½¿ç”¨ */
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  }

Â  Â  Â  Â  #message-display {Â 
Â  Â  Â  Â  Â  Â  font-size: 15vw;Â 
Â  Â  Â  Â  Â  Â  color: #ffffff;Â 
Â  Â  Â  Â  Â  Â  word-break: break-word;Â 
Â  Â  Â  Â  Â  Â  white-space: pre-wrap;Â 
Â  Â  Â  Â  Â  Â  font-weight: 900;Â 
Â  Â  Â  Â  Â  Â  line-height: 1.1;
Â  Â  Â  Â  Â  Â  transition: color 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .message-container.updated #message-display {Â 
Â  Â  Â  Â  Â  Â  color: #79f291 !important; /* æ›´æ–°æ™‚ã«æ˜ã‚‹ã„ç·‘ã«ç‚¹æ»… */
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  #status {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 5px;
Â  Â  Â  Â  Â  Â  right: 5px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: rgba(255, 255, 255, 0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #debug-info {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 5px;
Â  Â  Â  Â  Â  Â  left: 5px;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  color: rgba(255, 100, 100, 0.5);Â 
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  max-width: 90%;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
<div class="message-container" id="msg-box">
Â  Â  <div id="message-display">æ¥ç¶šä¸­...</div>
Â  Â  <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æœªæ¥ç¶š</div>
Â  Â  <div id="debug-info"></div>
</div>

<script>
    // Webãƒšãƒ¼ã‚¸ã‚’é…ä¿¡ã—ã¦ã„ã‚‹å—ä¿¡å´ESPã®ãƒ›ã‚¹ãƒˆåï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ã‚’å‹•çš„ã«å–å¾—ã—ã¾ã™ã€‚
    // ã“ã‚Œã«ã‚ˆã‚Šã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰æ›´ã•ã‚Œã¦ã‚‚è¿½å¾“ã§ãã€è‡ªå·±å‚ç…§ã«ã‚ˆã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’å›é¿ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚
    const RECEIVER_ESP_HOST = window.location.hostname || "192.168.4.1";
    const API_URL = `http://${RECEIVER_ESP_HOST}/message`;Â 
Â  Â  // ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ï¼ˆ1ç§’ï¼‰
Â  Â  const POLL_INTERVAL = 1000;

Â  Â  let lastMessage = "";Â 
Â  Â  const messageDisplay = document.getElementById('message-display');
Â  Â  const msgBox = document.getElementById('msg-box');
Â  Â  const statusDisplay = document.getElementById('status');
Â  Â  const debugInfo = document.getElementById('debug-info');

Â  Â  function logError(message) {
Â  Â  Â  Â  console.error(message);
Â  Â  Â  Â  // UIã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°
Â  Â  Â  Â  debugInfo.innerHTML = `ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${new Date().toLocaleTimeString()} - ${message}`;
Â  Â  }

Â  Â  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å‹•çš„ã«èª¿æ•´ã™ã‚‹é–¢æ•°
Â  Â  function adjustFontSize() {
Â  Â  Â  Â  // ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã‚’å–å¾—
Â  Â  Â  Â  const containerWidth = msgBox.clientWidth - 20;Â 
Â  Â  Â  Â  const containerHeight = msgBox.clientHeight - 20;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†è¨ˆç®—é–‹å§‹
Â  Â  Â  Â  messageDisplay.style.fontSize = '100px';Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  let fontSize = 100;
Â  Â  Â  Â Â 
Â  Â  Â  Â  while (messageDisplay.scrollWidth > containerWidth || messageDisplay.scrollHeight > containerHeight) {
Â  Â  Â  Â  Â  Â  fontSize -= 1;
Â  Â  Â  Â  Â  Â  if (fontSize < 10) break; // æœ€å°ã‚µã‚¤ã‚ºã‚¬ãƒ¼ãƒ‰
Â  Â  Â  Â  Â  Â  messageDisplay.style.fontSize = fontSize + 'px';
Â  Â  Â  Â  }

Â  Â  Â  Â  messageDisplay.style.fontSize = fontSize + 'px';
Â  Â  }

Â  Â  // æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹é–¢æ•°
Â  Â  function fetchMessage() {
Â  Â  Â  Â  statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒãƒ¼ãƒªãƒ³ã‚°ä¸­...';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);

Â  Â  Â  Â  fetch(API_URL, { 
            mode: 'cors',
            signal: controller.signal // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
        })
Â  Â  Â  Â  Â  Â  .then(response => {
                clearTimeout(timeoutId); // æˆåŠŸã—ãŸã‚‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
                    // HTTPã‚¨ãƒ©ãƒ¼ï¼ˆ4xx, 5xxï¼‰ã®å ´åˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`HTTP Error: ${response.status} (${response.statusText})`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return response.text();
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .then(data => {
                // æˆåŠŸ
Â  Â  Â  Â  Â  Â  Â  Â  statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ğŸŸ¢ æ¥ç¶šæ¸ˆã¿';
Â  Â  Â  Â  Â  Â  Â  Â  debugInfo.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (data !== lastMessage) {
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°æ™‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageDisplay.textContent = data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastMessage = data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adjustFontSize();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msgBox.classList.add('updated');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msgBox.classList.remove('updated');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(error => {
                // å¤±æ•—
                clearTimeout(timeoutId);

Â  Â  Â  Â  Â  Â  Â  Â  let errorMessage;

                if (error.name === 'AbortError') {
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                    errorMessage = "æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (3ç§’)ã€‚ESPãŒå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚";
                } else if (error instanceof TypeError && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«ã®ã‚¨ãƒ©ãƒ¼
                    errorMessage = `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚ãƒ‡ãƒã‚¤ã‚¹ãŒESPã®SoftAPã«æ¥ç¶šã—ã¦ã„ã‚‹ã‹ã€IP (${RECEIVER_ESP_HOST}) ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                } else {
                    errorMessage = `äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  logError(errorMessage);
Â  Â  Â  Â  Â  Â  Â  Â  statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼';
Â  Â  Â  Â  Â  Â  Â  Â  messageDisplay.textContent = 'ESPã‹ã‚‰ã®å¿œç­”ãªã—ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  adjustFontSize();
Â  Â  Â  Â  Â  Â  });
Â  Â  }

Â  Â  // PWA: ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ² 
Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  navigator.serviceWorker.register('service-worker.js', { scope: './' })
Â  Â  Â  Â  Â  .then(registration => {
Â  Â  Â  Â  Â  Â  console.log('Service Worker registered with scope:', registration.scope);
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  console.error('Service Worker registration failed:', error);
Â  Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }


Â  Â  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸè¨­å®š
Â  Â  window.onload = function() {
Â  Â  Â  Â  document.documentElement.style.height = '100%';
Â  Â  Â  Â  document.body.style.height = '100%';
Â  Â  Â  Â Â 
        // æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚’å®Ÿè¡Œã—ã€ä»¥é™1ç§’ã”ã¨ã«ç¹°ã‚Šè¿”ã™
Â  Â  Â  Â  fetchMessage();Â 
Â  Â  Â  Â  setInterval(fetchMessage, POLL_INTERVAL);Â 

Â  Â  Â  Â  window.addEventListener('resize', adjustFontSize);
Â  Â  };
</script>

</body>
</html>
