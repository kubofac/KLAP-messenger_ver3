<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLAP Messenger 受信機</title>
    <!-- Tailwind CSS CDN を使用 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントを適用 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        
        /* === CSS競合対策: HTMLとBODYの高さを強制的に確保 === */
        html, body {
            /* 高さを確実にビューポート全体に設定し、外部CSSの影響を排除 */
            height: 100vh !important; 
            margin: 0 !important;
            padding: 0 !important;
            font-family: 'Inter', sans-serif;
        }

        /* カスタムCSSは最小限にし、Tailwindクラスを優先 */
        
        /* メッセージ表示エリア (中央) のフォントサイズをレスポンシブに調整 */
        #received-message {
            /* 画面サイズに合わせた巨大なフォントサイズ (レスポンシブ) */
            font-size: clamp(3rem, 10vw, 8rem); 
            line-height: 1.1;
            word-wrap: break-word; 
        }

        /* スキャン中/エラー時のアニメーション */
        .dot-pulse {
            animation: dot-flicker 1.5s infinite;
        }
        @keyframes dot-flicker {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<!-- Tailwindクラスにほとんどのレイアウトを移行 -->
<body class="bg-gray-900 h-screen w-screen overflow-hidden text-gray-200">

    <!-- メインコンテナ: 画面全体を占有 (h-screen, w-screen) し、Flexboxで要素を配置 -->
    <div id="content-wrapper" class="flex flex-col h-full w-full justify-between items-center p-5 pb-24">
        
        <!-- ステータスインジケーター (上部) -->
        <div id="status-indicator" class="w-full text-center text-sm text-gray-400">
            <span id="ble-status">切断状態</span>
        </div>

        <!-- メッセージ表示エリア (中央で大きく表示) -->
        <div id="message-display" class="flex flex-grow w-full justify-center items-center text-center overflow-y-auto">
            <div id="received-message" class="font-extrabold text-amber-300 max-w-full">
                接続待機中...
            </div>
        </div>

    </div>
    
    <!-- 制御パネル (ボタン - 画面下部に固定) -->
    <div id="control-panel" class="fixed bottom-0 left-0 w-full p-4 bg-gray-900 border-t border-gray-700 flex justify-center shadow-lg">
        <button id="connect-button" 
            class="w-full max-w-md p-4 text-xl font-bold text-white rounded-xl cursor-pointer transition duration-300 transform 
                   bg-blue-600 hover:bg-blue-700 active:scale-98 shadow-xl">
            BLE接続を開始
        </button>
    </div>

    <script>
        // BLE 定数
        // デバイス名は「KLAP_Receiver_A_Data」に統一されています。
        const RECEIVER_DEVICE_NAME = 'KLAP_Receiver_A_Data'; 

        const SERVICE_UUID = '5fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const DATA_CHAR_UUID = 'beb5483e-36e1-45f1-b40b-361734a96b3a';
        
        // UI 要素
        const connectButton = document.getElementById('connect-button');
        const receivedMessageDiv = document.getElementById('received-message');
        const statusIndicator = document.getElementById('ble-status');

        let bleDevice;
        let dataCharacteristic;

        // UI の状態を更新するヘルパー関数
        function updateUI(message, statusText, isConnecting = false) {
            receivedMessageDiv.textContent = message;
            statusIndicator.textContent = statusText;
            connectButton.disabled = isConnecting;

            // ボタンの色の切り替え (Tailwindクラスを操作)
            const baseClasses = 'w-full max-w-md p-4 text-xl font-bold text-white rounded-xl cursor-pointer transition duration-300 transform shadow-xl';
            let dynamicClasses = '';

            if (isConnecting) {
                dynamicClasses = 'bg-blue-400 cursor-wait';
            } else if (bleDevice?.gatt?.connected) {
                // 接続中の色 (切断ボタンとして機能)
                dynamicClasses = 'bg-red-600 hover:bg-red-700 active:scale-98';
                connectButton.textContent = 'BLE切断';
            } else {
                // 切断中の色 (接続ボタンとして機能)
                dynamicClasses = 'bg-blue-600 hover:bg-blue-700 active:scale-98';
                connectButton.textContent = 'BLE接続を開始';
            }
            
            connectButton.className = `${baseClasses} ${dynamicClasses}`;

            // ステータスアニメーションの制御
            statusIndicator.classList.toggle('dot-pulse', isConnecting);
        }

        // ----------------------------------------------------
        // BLE 接続処理
        // ----------------------------------------------------

        async function connectBLE() {
            if (bleDevice && bleDevice.gatt && bleDevice.gatt.connected) {
                // 既に接続済みの場合、切断処理を実行
                console.log('Disconnecting from device...');
                bleDevice.gatt.disconnect();
                return;
            }

            try {
                // UIの更新 (スキャン開始)
                updateUI('スキャン中...', 'スキャン中...', true);

                // 1. デバイススキャン
                const options = {
                    // デバイス名をフィルタに使用
                    filters: [{ name: RECEIVER_DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID]
                };
                
                console.log('Requesting device...');
                bleDevice = await navigator.bluetooth.requestDevice(options);
                bleDevice.addEventListener('gattserverdisconnected', onDeviceDisconnected);

                // 2. GATT サーバー接続
                updateUI('接続中...', '接続試行中...', true);
                const server = await bleDevice.gatt.connect();

                // 3. サービス取得
                updateUI('サービス検索中...', 'サービス検索中...', true);
                const service = await server.getPrimaryService(SERVICE_UUID);

                // 4. 特性取得 (Notify 特性)
                updateUI('特性取得中...', '特性取得中...', true);
                dataCharacteristic = await service.getCharacteristic(DATA_CHAR_UUID);
                
                // 5. Notifyの開始
                updateUI('通知設定中...', '通知設定中...', true);
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                
                // UIの更新 (接続成功)
                updateUI('受信待機中', '接続完了 (受信中)', false);

            } catch (error) {
                console.error('BLE接続エラー:', error);
                
                let errorMessage;
                if (error.name === 'NotFoundError') {
                    errorMessage = 'デバイスが見つかりません。ESP32の起動/$\text{UUID}$ を確認してください。';
                } else if (error.name === 'NotAllowedError') {
                    errorMessage = '$\text{BLE}$ 権限が拒否されました。設定を確認してください。';
                } else if (error.name === 'NetworkError') {
                    errorMessage = '接続がタイムアウトしました。デバイスがスキャン範囲内にありますか？';
                }
                else {
                    errorMessage = `接続失敗: ${error.name}`;
                }

                // UIの更新 (接続失敗)
                updateUI(errorMessage, 'エラー', false);
                
                dataCharacteristic = null;
                bleDevice = null;
            }
        }

        // ----------------------------------------------------
        // 通知ハンドラ
        // ----------------------------------------------------

        function handleNotifications(event) {
            const value = event.target.value;
            // DataViewからUTF-8文字列としてデコード
            const receivedText = new TextDecoder('utf-8').decode(value);
            
            console.log('Received:', receivedText);
            
            // 画面にメッセージを表示
            receivedMessageDiv.textContent = receivedText;
            // メッセージ受信後もステータスは「接続完了」を維持
            statusIndicator.textContent = '接続完了 (受信中)';
        }

        // ----------------------------------------------------
        // 切断ハンドラ
        // ----------------------------------------------------

        function onDeviceDisconnected(event) {
            const device = event.target;
            console.log('Device disconnected:', device.name);
            
            // UIの更新 (切断)
            updateUI('接続が切断されました。', '切断状態', false);
            
            dataCharacteristic = null;
            bleDevice = null;
        }

        // ----------------------------------------------------
        // イベントリスナー
        // ----------------------------------------------------

        connectButton.addEventListener('click', connectBLE);
        
        // ページロード時の初期メッセージ
        window.onload = () => {
            updateUI('接続待機中...', '切断状態', false);
            console.log("Receiver App Ready. Check UUIDs and Device Name.");
        };

    </script>
</body>
</html>
