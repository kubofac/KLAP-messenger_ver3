<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>KLAP_messenger (WiFi-BLE)</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        /* ç”»é¢å…¨ä½“ã®è¨­å®š */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 100vh;
            background-color: #000000;
            color: #ffffff;
            padding: 0;
            position: relative;
        }

        /* ç”»é¢ä¸­å¤®ã«é…ç½®ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        #content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            width: 100%;
            padding: 10px 0;
            box-sizing: border-box;
            /* ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä¸‹ã«é…ç½® */
            padding-top: 50px; 
        }
        
        /* ãƒ”ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º */
        #pitMessageDisplay {
            width: 95%;
            font-size: 15vh;
            font-weight: bold;
            color: #ffeb3b;
            background: #000000;
            border: none;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            margin: 0;
            padding: 0;
            flex-shrink: 0;
        }

        /* ãƒœã‚¿ãƒ³è¡Œï¼ˆç”»é¢ä¸‹æ®µã«å›ºå®šï¼‰ */
        #buttons-row {
            display: flex;
            justify-content: center;
            width: 100%;
            gap: 20px;
            padding: 10px 20px;
            flex-shrink: 0;
            margin-top: auto;
            box-sizing: border-box;
        }
        
        .button {
            border: 1px solid #3a3a3c;
            background-color: #2c2c2e;
            padding: 18px 30px;
            color: #ffffff;
            font-size: 20px;
            font-weight: 500;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: center;
            flex-grow: 1;
            max-width: 300px;
        }
        
        .button:hover { background-color: #4a4a4e; }

        .ble-disconnected { background-color: #ff4d4d !important; border-color: #993333;}
        .ble-connected { background-color: #007aff !important; border-color: #0066cc;}

        /* ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆä¸Šéƒ¨ã«å›ºå®šï¼‰ */
        #debug-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: #999999;
            padding: 5px 10px;
            font-size: 14px;
            line-height: 1.5;
            box-sizing: border-box;
            z-index: 5;
            flex-shrink: 0;
        }
        .status-text { text-align: left; margin: 0; }
        .status-good { color: #00ff00; } 
        .status-bad { color: #ff4d4d; }

        /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ (ç‰¹ã«ç¸¦å‘ãã‚„éå¸¸ã«å°ã•ãªç”»é¢ç”¨) */
        @media (max-height: 400px) and (orientation: landscape) {
            #pitMessageDisplay {
                font-size: 12vh;
            }
        }
    </style>
</head>

<body>
<div id="debug-overlay">
    <p id="data-status-display" class="status-text">ãƒ‡ãƒ¼ã‚¿æ¥ç¶š: å¾…æ©Ÿä¸­</p>
    <p id="send-status-display" class="status-text">é€ä¿¡çµæœ: å¾…æ©Ÿä¸­</p>
</div>

<div id="content-wrapper">
    <div id="pitMessageDisplay">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
</div>

<div id="buttons-row">
    <button id="bleConnectButton" class="button ble-disconnected">å…¨BLEã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶š</button>
</div>

<script>
'use strict';

// =========================================================
// 1. UUID å®šç¾©ã¨DOMè¦ç´ 
// =========================================================

// â˜…â˜…â˜… å—ä¿¡å´ESP32-C3 Mini (ãƒ‡ãƒ¼ã‚¿å—ä¿¡) ã®UUIDã¨ãƒ‡ãƒã‚¤ã‚¹å â˜…â˜…â˜…
const DATA_SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
const DATA_CHAR_UUID = 'beb5483e-36e1-45f1-b40b-361734a96b3a';
const DATA_RECEIVER_DEVICE_NAME = 'ESP32_Receiver_B_Data';

// â˜…â˜…â˜… é€ä¿¡å´ESP32 (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥) ã®UUIDã¨ãƒ‡ãƒã‚¤ã‚¹å â˜…â˜…â˜…
const STATUS_SERVICE_UUID = '5fafc201-1fb5-459e-8fcc-c5c9c331914b';
const STATUS_CHAR_UUID = 'cfb5483e-36e1-45f1-b40b-361734a96b3a';
const STATUS_SENDER_DEVICE_NAME = 'ESP32_Sender_A_Status';

// BLEæ¥ç¶šå¤‰æ•°
let dataCharacteristic;
let statusCharacteristic;

// DOMè¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const elem = {
    dataStatusDisplay: null,    
    sendStatusDisplay: null,    
    bleConnectButton: null,
    pitMessageDisplay: null
};

// ----------------------------------------------------
// 2. BLEé€šä¿¡é–¢æ•° (2ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶š)
// ----------------------------------------------------

/**
 * [ãƒ¡ã‚¤ãƒ³æ¥ç¶š] å…¨ã¦ã®BLEã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ¥ç¶šã‚’é–‹å§‹
 */
function connectAllServices() {
    elem.bleConnectButton.textContent = 'æ¥ç¶šä¸­...';
    // ãƒ‡ãƒ¼ã‚¿å—ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ (ESP32-C3) ã¸ã®æ¥ç¶š
    connectToDataService();
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ (ESP32é€ä¿¡æ©Ÿ) ã¸ã®æ¥ç¶š
    connectToStatusService();
}

/**
 * [ãƒ‡ãƒ¼ã‚¿å—ä¿¡] å—ä¿¡å´ESP32-C3 Miniã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶š
 */
async function connectToDataService() {
    try {
        // ğŸš¨ æœ€çµ‚ä¿®æ­£: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Œå…¨ã«è§£é™¤ (æœ€å¼±ãƒ•ã‚£ãƒ«ã‚¿)
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true, // ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
            optionalServices: [DATA_SERVICE_UUID]
        });
        
        device.addEventListener('gattserverdisconnected', onDataDeviceDisconnected);
        updateStatusDisplay(elem.dataStatusDisplay, `ãƒ‡ãƒ¼ã‚¿æ¥ç¶šè©¦è¡Œä¸­... (${device.name})`);

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(DATA_SERVICE_UUID);
        dataCharacteristic = await service.getCharacteristic(DATA_CHAR_UUID);
        
        await dataCharacteristic.startNotifications();
        dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataUpdate);

        updateStatusDisplay(elem.dataStatusDisplay, 'ãƒ‡ãƒ¼ã‚¿æ¥ç¶š: OK. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›£è¦–ä¸­ã€‚', 'status-good');
        updateButtonStatus(true);

    } catch (error) {
        console.error('BLE Data Connection Error:', error);
        updateStatusDisplay(elem.dataStatusDisplay, `ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'status-bad');
        updateButtonStatus(false);
    }
}

/**
 * [ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥] é€ä¿¡å´ESP32ã‹ã‚‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶š
 */
async function connectToStatusService() {
    try {
        // ğŸš¨ æœ€çµ‚ä¿®æ­£: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Œå…¨ã«è§£é™¤ (æœ€å¼±ãƒ•ã‚£ãƒ«ã‚¿)
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true, // ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
            optionalServices: [STATUS_SERVICE_UUID]
        });

        device.addEventListener('gattserverdisconnected', onStatusDeviceDisconnected);
        updateStatusDisplay(elem.sendStatusDisplay, `é€ä¿¡çµæœæ¥ç¶šè©¦è¡Œä¸­... (${device.name})`);

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(STATUS_SERVICE_UUID);
        statusCharacteristic = await service.getCharacteristic(STATUS_CHAR_UUID);
        
        await statusCharacteristic.startNotifications();
        statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusUpdate);

        updateStatusDisplay(elem.sendStatusDisplay, 'é€ä¿¡çµæœæ¥ç¶š: OK. ç›£è¦–ä¸­ã€‚', 'status-good');
        updateButtonStatus(true);

    } catch (error) {
        console.error('BLE Status Connection Error:', error);
        updateStatusDisplay(elem.sendStatusDisplay, `é€ä¿¡çµæœæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'status-bad');
        updateButtonStatus(false);
    }
}

// ----------------------------------------------------
// 3. ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
// ----------------------------------------------------

/**
 * [ãƒ‡ãƒ¼ã‚¿å—ä¿¡] å—ä¿¡å´(B)ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãŸã¨ãã®å‡¦ç†
 */
function handleDataUpdate(event) {
    const value = event.target.value;
    const decoder = new TextDecoder('utf-8');
    const receivedString = decoder.decode(value).trim();
    
    console.log(`[DATA] Received: ${receivedString}`);

    if (elem.pitMessageDisplay) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ã®åˆ¤å®š
        if (receivedString === '' || receivedString.toLowerCase() === 'ãªã—' || receivedString.toLowerCase() === 'clear') {
            elem.pitMessageDisplay.textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã£ã¦ã„ã¾ã™...';
        } else {
            elem.pitMessageDisplay.textContent = receivedString;
        }
    }
}

/**
 * [ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥] é€ä¿¡å´(A)ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å—ä¿¡ã—ãŸã¨ãã®å‡¦ç†
 */
function handleStatusUpdate(event) {
    const value = event.target.value;
    const statusText = new TextDecoder('utf-8').decode(value.buffer).trim();
    
    console.log('Received ESP-NOW Status:', statusText);
    
    let colorClass = 'status-text';
    if (statusText.includes('æˆåŠŸ')) {
        colorClass = 'status-good';
    } else if (statusText.includes('å¤±æ•—') || statusText.includes('åœå¤–')) {
        colorClass = 'status-bad';
    }
    
    updateStatusDisplay(elem.sendStatusDisplay, `é€ä¿¡çµæœ: ${statusText}`, colorClass);
}


/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡æ–­ã•ã‚ŒãŸã¨ãã®å‡¦ç†
 */
function onDataDeviceDisconnected(event) {
    console.warn('ãƒ‡ãƒ¼ã‚¿BLEãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ:', event.target.name);
    updateStatusDisplay(elem.dataStatusDisplay, 'ãƒ‡ãƒ¼ã‚¿æ¥ç¶š: åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚', 'status-bad');
    elem.pitMessageDisplay.textContent = 'æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã—ã¦ãã ã•ã„ã€‚';
    elem.pitMessageDisplay.style.color = '#ff4d4d'; 
    updateButtonStatus(false);
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡æ–­ã•ã‚ŒãŸã¨ãã®å‡¦ç†
 */
function onStatusDeviceDisconnected(event) {
    console.warn('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹BLEãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ:', event.target.name);
    updateStatusDisplay(elem.sendStatusDisplay, 'é€ä¿¡çµæœæ¥ç¶š: åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚', 'status-bad');
    updateButtonStatus(false);
}


// ----------------------------------------------------
// 4. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¨åˆæœŸåŒ–
// ----------------------------------------------------

/**
 * ç”»é¢ä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ›´æ–°ã™ã‚‹
 */
function updateStatusDisplay(element, text, className = 'status-text') {
    if (element) {
        element.textContent = text;
        element.className = 'status-text ' + className;
    }
}

/**
 * æ¥ç¶šãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
 */
function updateButtonStatus(isConnected) {
    // ã©ã¡ã‚‰ã‹ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚Œã°ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã¯ä¸€æ—¦CONNECTEDã¨ã™ã‚‹
    // å³å¯†ã«ã¯ä¸¡æ–¹æ¥ç¶šã•ã‚ŒãŸã‚‰CONNECTEDã¨ã™ã¹ãã ãŒã€ã“ã“ã§ã¯æ¥ç¶šè©¦è¡Œã®çµæœã«ä¾å­˜
    if (isConnected) {
        elem.bleConnectButton.textContent = 'BLE æ¥ç¶šæ¸ˆã¿';
        elem.bleConnectButton.classList.remove('ble-disconnected');
        elem.bleConnectButton.classList.add('ble-connected');
    } else {
        elem.bleConnectButton.textContent = 'å…¨BLEã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶š';
        elem.bleConnectButton.classList.remove('ble-connected');
        elem.bleConnectButton.classList.add('ble-disconnected');
    }
}


window.addEventListener('load', () => {
    // Service Workerã®ç™»éŒ²ï¼ˆPWAã¨ã—ã¦å‹•ä½œã•ã›ã‚‹å ´åˆï¼‰
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(error => {
                console.log('Service Worker registration failed:', error);
            });
    }

    // DOMè¦ç´ ã®å–å¾—
    elem.dataStatusDisplay = document.getElementById('data-status-display');
    elem.sendStatusDisplay = document.getElementById('send-status-display');
    elem.bleConnectButton = document.getElementById('bleConnectButton');
    elem.pitMessageDisplay = document.getElementById('pitMessageDisplay');

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    if (elem.bleConnectButton) elem.bleConnectButton.addEventListener('click', connectAllServices);
    
    // åˆæœŸè¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ–‡å­—è‰²ã‚’é»„è‰²ã«å›ºå®š
    if (elem.pitMessageDisplay) elem.pitMessageDisplay.style.color = '#ffeb3b';

    // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    updateStatusDisplay(elem.dataStatusDisplay, 'ãƒ‡ãƒ¼ã‚¿æ¥ç¶š: å¾…æ©Ÿä¸­');
    updateStatusDisplay(elem.sendStatusDisplay, 'é€ä¿¡çµæœ: å¾…æ©Ÿä¸­');
});
</script>
</body>
</html>
