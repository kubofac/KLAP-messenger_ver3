<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWAマニフェストファイルの参照 -->
    <link rel="manifest" href="manifest.json">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => {
        console.log('Service Worker registered! Scope:', registration.scope);
      })
      .catch(err => {
        console.log('Service Worker registration failed:', err);
      });
  });
}
</script>


    
    <title>klap-messenger</title>
    <style>
        /* CSSはサインボードの要件を維持（背景黒、文字白、巨大フォント） */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000000;
            margin: 0; 
            padding: 0; 
            color: #ffffff;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow: hidden;
            text-align: center;
        }
        
        .message-container { 
            width: 90vw; /* 画面幅の90%を使用 */
            height: 90vh; /* 画面高さの90%を使用 */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
        }

        #message-display { 
            font-size: 15vw; 
            color: #ffffff; 
            word-break: break-word; 
            white-space: pre-wrap; 
            font-weight: 900; 
            line-height: 1.1;
            transition: color 0.3s ease;
        }
        
        .updated { 
            color: #79f291 !important; 
        } 
        
        #status {
            position: fixed;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
        }
        
        #debug-info {
            position: fixed;
            bottom: 5px;
            left: 5px;
            font-size: 10px;
            color: rgba(255, 100, 100, 0.5); 
            text-align: left;
            max-width: 90%;
        }
    </style>
</head>
<body>
<div class="message-container" id="msg-box">
    <div id="message-display">接続中...</div>
    <div id="status">ステータス: 未接続</div>
    <div id="debug-info"></div>
</div>

<script>
    // --- 【重要】ESP32のIPアドレスを設定してください ---
    const ESP32_IP = "192.168.4.1";
    const API_URL = `http://${ESP32_IP}/message`; 
    // --------------------------------------------------

    let lastMessage = ""; 
    const messageDisplay = document.getElementById('message-display');
    const msgBox = document.getElementById('msg-box');
    const statusDisplay = document.getElementById('status');
    const debugInfo = document.getElementById('debug-info');

    function logError(message) {
        console.error(message);
        debugInfo.innerHTML = "エラー発生: " + message;
    }

    // フォントサイズを動的に調整する関数
    function adjustFontSize() {
        const containerWidth = msgBox.clientWidth - 20; 
        const containerHeight = msgBox.clientHeight - 20; 
        
        messageDisplay.style.fontSize = '100px'; 
        
        let fontSize = 100;
        
        while (messageDisplay.scrollWidth > containerWidth || messageDisplay.scrollHeight > containerHeight) {
            fontSize -= 1;
            if (fontSize < 10) break;
            messageDisplay.style.fontSize = fontSize + 'px';
        }

        messageDisplay.style.fontSize = fontSize + 'px';
    }

    // 最新メッセージを取得する関数
    function fetchMessage() {
        statusDisplay.textContent = 'ステータス: ポーリング中...';
        
        fetch(API_URL, { mode: 'cors' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} (${response.statusText})`);
                }
                return response.text();
            })
            .then(data => {
                statusDisplay.textContent = 'ステータス: 接続済み';
                debugInfo.innerHTML = '';
                
                if (data !== lastMessage) {
                    messageDisplay.textContent = data;
                    lastMessage = data;
                    
                    adjustFontSize();
                    
                    msgBox.classList.add('updated');
                    setTimeout(() => {
                        msgBox.classList.remove('updated');
                    }, 500);
                }
            })
            .catch(error => {
                let errorMessage = error.message;

                if (error instanceof TypeError && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                    errorMessage = "ネットワーク接続エラー。デバイスが 'ESP32_Receiver' に接続しているか、IP: 192.168.4.1 が利用可能か確認してください。";
                } else if (error.message.includes('Load failed')) {
                     errorMessage = "ブラウザセキュリティエラー。ローカルファイル (file://) からのアクセスがブロックされている可能性があります。";
                }
                
                logError(errorMessage);
                statusDisplay.textContent = 'ステータス: ❌ 接続エラー';
                messageDisplay.textContent = '❌ エラーが発生しました。詳細を左下に表示。';
                adjustFontSize();
            });
    }

    // PWA: サービスワーカーの登録
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      });
    }


    // ページロード時の初期設定
    window.onload = function() {
        document.documentElement.style.height = '100%';
        document.body.style.height = '100%';
        
        fetchMessage(); 
        setInterval(fetchMessage, 1000); 

        window.addEventListener('resize', adjustFontSize);
    };
</script>

</body>
</html>

