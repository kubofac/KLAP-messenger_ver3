<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

    <title>KLAP_messenger</title>
    <style>
        /* CSSã¯ã‚µã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ã®è¦ä»¶ã‚’ç¶­æŒï¼ˆèƒŒæ™¯é»’ã€æ–‡å­—ç™½ã€å·¨å¤§ãƒ•ã‚©ãƒ³ãƒˆï¼‰ */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000000;
            margin: 0; 
            padding: 0; 
            color: #ffffff;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow: hidden;
            text-align: center;
        }
         
        .message-container { 
            width: 90vw; /* ç”»é¢å¹…ã®90%ã‚’ä½¿ç”¨ */
            height: 90vh; /* ç”»é¢é«˜ã•ã®90%ã‚’ä½¿ç”¨ */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
        }

        #message-display { 
            /* åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¯ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå˜ä½ã§å·¨å¤§ã« */
            font-size: 15vw; 
            color: #ffffff; 
            word-break: break-word; 
            white-space: pre-wrap; 
            font-weight: 900; 
            line-height: 1.1;
            transition: color 0.3s ease;
        }
         
        /* æ›´æ–°æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        .updated { 
            color: #79f291 !important; /* æ˜ã‚‹ã„ç·‘è‰²ã«ç‚¹æ»… */
        } 
         
        /* æ¥ç¶šçŠ¶æ…‹ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
        #status {
            position: fixed;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
<div class="message-container" id="msg-box">
    <div id="message-display">æ¥ç¶šä¸­...</div>
    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æœªæ¥ç¶š</div>
</div>

<script>
    // ğŸ’¡ ã€PWAã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã®ãŸã‚Service Workerã‚’ç™»éŒ²ã™ã‚‹ã€‘ ğŸ’¡
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker registered: ', registration);
          })
          .catch(error => {
            console.log('Service Worker registration failed: ', error);
          });
      });
    }

    // --- ã€é‡è¦ã€‘ESP32ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ ---
    // SoftAPã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ 192.168.4.1 ã§ã™ã€‚
    const ESP32_IP = "192.168.4.1";
    const API_URL = `http://${ESP32_IP}/message`; 
    // --------------------------------------------------

    let lastMessage = ""; 
    const messageDisplay = document.getElementById('message-display');
    const msgBox = document.getElementById('msg-box');
    const statusDisplay = document.getElementById('status');
    const LOCAL_STORAGE_KEY = 'last_klap_message'; // â˜…ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ã‚’è¿½åŠ 

    // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å‹•çš„ã«èª¿æ•´ã™ã‚‹é–¢æ•°
    function adjustFontSize() {
        const containerWidth = msgBox.clientWidth - 20; 
        const containerHeight = msgBox.clientHeight - 20; 
        
        messageDisplay.style.fontSize = '100px'; 
        
        let fontSize = 100;
        
        while (messageDisplay.scrollWidth > containerWidth || messageDisplay.scrollHeight > containerHeight) {
            fontSize -= 1;
            if (fontSize < 10) break;
            messageDisplay.style.fontSize = fontSize + 'px';
        }

        messageDisplay.style.fontSize = fontSize + 'px';
    }

    // æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹é–¢æ•° (â˜… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã®ãŸã‚ä¿®æ­£)
    function fetchMessage() {
        statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒãƒ¼ãƒªãƒ³ã‚°ä¸­...';
        
        fetch(API_URL)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ¥ç¶šæ¸ˆã¿';
                
                if (data !== lastMessage) {
                    messageDisplay.textContent = data;
                    lastMessage = data;
                    
                    // æ­£å¸¸ã«å–å¾—ã§ããŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    localStorage.setItem(LOCAL_STORAGE_KEY, data); 

                    adjustFontSize();
                    
                    // æ›´æ–°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    msgBox.classList.add('updated');
                    setTimeout(() => {
                        msgBox.classList.remove('updated');
                    }, 500);
                }
            })
            .catch(error => {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã€å‰å›ä¿å­˜ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€
                const savedMessage = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedMessage) {
                    // å‰å›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ã€ãã‚Œã‚’è¡¨ç¤ºã—ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’é€šçŸ¥
                    statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
                    if (messageDisplay.textContent !== savedMessage) {
                        messageDisplay.textContent = savedMessage;
                        lastMessage = savedMessage; 
                        adjustFontSize();
                    }
                } else {
                    // å‰å›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ãªã‘ã‚Œã°ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                    messageDisplay.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    adjustFontSize();
                }
            });
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸè¨­å®š
    window.onload = function() {
        // ç”»é¢å…¨ä½“ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«body/htmlã®é«˜ã•ã‚‚è¨­å®š
        document.documentElement.style.height = '100%';
        document.body.style.height = '100%';
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å‰å›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã€åˆæœŸè¡¨ç¤º
        const savedMessage = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedMessage) {
            messageDisplay.textContent = savedMessage;
            lastMessage = savedMessage;
            adjustFontSize();
            statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: â³ (å‰å›ãƒ‡ãƒ¼ã‚¿)';
        }

        fetchMessage(); // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å³åº§ã«å–å¾—
        
        // 1ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
        setInterval(fetchMessage, 1000); 

        // ç”»é¢ãƒªã‚µã‚¤ã‚ºæ™‚ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å†èª¿æ•´
        window.addEventListener('resize', adjustFontSize);
    };
</script>

</body>
</html>
