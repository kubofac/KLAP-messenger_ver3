<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLAP Messenger 受信機</title>
    <!-- Tailwind CSS CDN を使用 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントを適用 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000000; /* 全体背景を黒に */
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* スクロール防止 */
        }
        /* メインコンテンツを画面中央に配置し、柔軟に対応 */
        #content-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        /* メッセージ表示エリア (中央) */
        #message-display {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1; /* 中央エリアを最大限に拡大 */
            width: 100%;
            text-align: center;
            word-wrap: break-word; /* 長い単語の折り返し */
        }
        #received-message {
            /* 画面サイズに合わせた巨大なフォントサイズ (レスポンシブ) */
            font-size: clamp(3rem, 10vw, 8rem); 
            font-weight: 700;
            color: #FFD700; /* メッセージを黄色 (Gold) に */
            line-height: 1.1;
            max-height: 80vh;
            overflow: hidden;
            padding: 10px;
        }
        /* ボタンコンテナ (下部) */
        #control-panel {
            width: 100%;
            padding: 20px 0 30px 0;
            display: flex;
            justify-content: center;
        }
        .btn-connect {
            padding: 1rem 2rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            background-color: #4f46e5; /* Indigo */
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-connect:hover {
            background-color: #4338ca;
        }
        .btn-connect:active {
            transform: translateY(1px);
        }
        .btn-connect:disabled {
            background-color: #6366f1;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="content-wrapper">
        <!-- メッセージ表示エリア -->
        <div id="message-display">
            <div id="received-message">
                接続待機中...
            </div>
        </div>

        <!-- 制御パネル -->
        <div id="control-panel">
            <button id="connect-button" class="btn-connect">
                BLE接続
            </button>
        </div>
    </div>

    <script>
        // BLE 定数
        // [重要] デバイス名は、ESP32-C3（受信機）側のC++コードのDEVICE_NAMEと一致させてください。
        const RECEIVER_DEVICE_NAME = 'ESP32_Receiver_A_Data'; 

        // [修正済み] サービスUUIDをC++コード（5faf...）と統一
        const SERVICE_UUID = '5fafc201-1fb5-459e-8fcc-c5c9c331914b';

        // [確認] データ特性UUIDもESP32-C3側のコードと一致させてください。
        const DATA_CHAR_UUID = 'beb5483e-36e1-45f1-b40b-361734a96b3a';
        
        // UI 要素
        const connectButton = document.getElementById('connect-button');
        const receivedMessageDiv = document.getElementById('received-message');

        let bleDevice;
        let dataCharacteristic;

        // ----------------------------------------------------
        // BLE 接続処理
        // ----------------------------------------------------

        async function connectBLE() {
            if (bleDevice && bleDevice.gatt && bleDevice.gatt.connected) {
                // 既に接続済みの場合、切断処理を実行
                bleDevice.gatt.disconnect();
                return;
            }

            try {
                receivedMessageDiv.textContent = 'スキャン中...';
                connectButton.disabled = true;
                connectButton.textContent = 'スキャン中...';

                // 1. デバイススキャン
                const options = {
                    // デバイス名をフィルタに使用
                    filters: [{ name: RECEIVER_DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID]
                };
                
                bleDevice = await navigator.bluetooth.requestDevice(options);
                bleDevice.addEventListener('gattserverdisconnected', onDeviceDisconnected);

                // 2. GATT サーバー接続
                const server = await bleDevice.gatt.connect();
                receivedMessageDiv.textContent = '接続確立。サービス検索中...';

                // 3. サービス取得
                const service = await server.getPrimaryService(SERVICE_UUID);
                receivedMessageDiv.textContent = '特性取得中...';

                // 4. 特性取得 (Notify 特性)
                dataCharacteristic = await service.getCharacteristic(DATA_CHAR_UUID);
                
                // 5. Notifyの開始
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                
                receivedMessageDiv.textContent = '接続成功。メッセージ待機中...';
                connectButton.textContent = '切断';
                connectButton.disabled = false;

            } catch (error) {
                console.error('BLE接続エラー:', error);
                
                let errorMessage;
                if (error.name === 'NotFoundError') {
                    errorMessage = `デバイス「${RECEIVER_DEVICE_NAME}」が見つかりません。電源やUUIDを確認してください。`;
                } else {
                    errorMessage = `接続失敗: ${error.name}`;
                }

                receivedMessageDiv.textContent = errorMessage;
                connectButton.disabled = false;
                connectButton.textContent = '再接続';
                
                dataCharacteristic = null;
                bleDevice = null;
            }
        }

        // ----------------------------------------------------
        // 通知ハンドラ
        // ----------------------------------------------------

        function handleNotifications(event) {
            const value = event.target.value;
            // DataViewからUTF-8文字列としてデコード
            const receivedText = new TextDecoder('utf-8').decode(value);
            
            console.log('Received:', receivedText);
            
            // 画面にメッセージを表示
            receivedMessageDiv.textContent = receivedText;
        }

        // ----------------------------------------------------
        // 切断ハンドラ
        // ----------------------------------------------------

        function onDeviceDisconnected(event) {
            const device = event.target;
            console.log('Device disconnected:', device.name);
            
            receivedMessageDiv.textContent = '切断されました。再接続してください。';
            connectButton.textContent = '再接続';
            connectButton.disabled = false;
            
            dataCharacteristic = null;
            bleDevice = null;
        }

        // ----------------------------------------------------
        // イベントリスナー
        // ----------------------------------------------------

        connectButton.addEventListener('click', connectBLE);
        
        // ページロード時の初期メッセージ
        window.onload = () => {
            console.log("Receiver App Ready. Check UUIDs and Device Name.");
        };

    </script>
</body>
</html>
