<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLAP Messenger - 受信側</title>
    <!-- Tailwind CSS CDNをロード -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .message-history::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .message-history {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-lg bg-white shadow-xl rounded-2xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 text-green-500 mr-2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113A.375.375 0 019.75 15V8.52a.375.375 0 01.557-.323l5.603 3.113z" />
            </svg>
            KLAP 受信機
        </h1>
        <p class="text-sm text-gray-500 mb-6">ESP32 サーバーに接続し、$\text{ESP}-\text{NOW}$ 経由で届いたメッセージを受信します。</p>

        <!-- 接続ステータス -->
        <div id="status-display" class="mb-6 p-3 rounded-lg text-sm font-medium transition-all duration-300 bg-indigo-100 text-indigo-800">
            ステータス: 未接続
        </div>

        <!-- 受信メッセージ表示エリア -->
        <div class="mb-6 h-64 overflow-y-auto border border-gray-300 rounded-xl p-4 message-history bg-white shadow-inner">
            <p class="text-xs text-gray-500 text-center italic mt-2" id="initial-message">接続後、送信機からメッセージを待機します...</p>
            <div id="received-message-container" class="space-y-3">
                <!-- 受信メッセージがここに追加される -->
            </div>
        </div>

        <!-- 接続ボタン -->
        <button id="connect-button" class="w-full py-3 px-4 rounded-xl font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-md shadow-indigo-300 disabled:opacity-50" onclick="handleConnect()">
            <span id="button-text">ESP32 受信機に接続</span>
        </button>
    </div>

    <script>
        // UUIDs (ESP32_Receiver_A_Data.ino と一致させること)
        const SERVICE_UUID = '5fafc201-1fb5-459e-8fcc-c5c9c331914b';
        // ESP32 Receiverからのデータを受信する特性 (ReceiverのData Characteristic)
        const DATA_CHAR_UUID = 'beb5483e-36e1-45f1-b40b-361734a96b3a'; 
        
        // デバイス名 (ESP32_Receiver_A_Data.ino のアドバタイズ名と一致させること)
        const DEVICE_NAME = 'ESP32_Receiver_A_Data';

        let bleDevice = null;
        let dataCharacteristic = null;

        const statusDisplay = document.getElementById('status-display');
        const connectButton = document.getElementById('connect-button');
        const buttonText = document.getElementById('button-text');
        const receivedMessageContainer = document.getElementById('received-message-container');
        const initialMessage = document.getElementById('initial-message');

        // ユーティリティ関数: ステータス表示の更新
        function updateStatus(message, type = 'info') {
            statusDisplay.textContent = `ステータス: ${message}`;
            statusDisplay.className = 'mb-6 p-3 rounded-lg text-sm font-medium transition-all duration-300';

            switch (type) {
                case 'success':
                    statusDisplay.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    statusDisplay.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'warning':
                    statusDisplay.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                default:
                    statusDisplay.classList.add('bg-indigo-100', 'text-indigo-800');
            }
        }

        // ユーティリティ関数: 受信メッセージを画面に追加
        function addReceivedMessage(text) {
            initialMessage.classList.add('hidden'); // 初期メッセージを非表示にする
            const time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const div = document.createElement('div');
            div.className = 'p-3 bg-green-50 border border-green-200 rounded-lg shadow-sm';
            
            const messageText = document.createElement('p');
            messageText.className = 'text-gray-700 font-medium break-words';
            messageText.textContent = text;
            
            const timeStamp = document.createElement('p');
            timeStamp.className = 'text-xs text-green-600 mt-1 text-right font-mono';
            timeStamp.textContent = `受信時刻: ${time}`;

            div.appendChild(messageText);
            div.appendChild(timeStamp);
            
            // 最新のメッセージを一番上に表示
            receivedMessageContainer.prepend(div);
        }

        // データ特性からの通知ハンドラ (メッセージ受信)
        function handleDataNotifications(event) {
            const value = event.target.value;
            const receivedMessage = new TextDecoder().decode(value).trim();
            
            console.log('Received Message via BLE:', receivedMessage);
            addReceivedMessage(receivedMessage);
            updateStatus('メッセージを受信しました！', 'success');
        }

        // 接続処理
        async function handleConnect() {
            if (bleDevice && bleDevice.gatt.connected) {
                // 既に接続済みの場合、切断
                bleDevice.gatt.disconnect();
                return;
            }

            try {
                updateStatus('デバイスをスキャン中...', 'info');
                connectButton.disabled = true;
                buttonText.textContent = 'スキャン中...';

                // 1. デバイススキャン
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus(`デバイス "${bleDevice.name}" を検出。接続中...`, 'info');
                
                // 2. GATTサーバーに接続
                const server = await bleDevice.gatt.connect();
                updateStatus('接続成功。サービスを取得中...', 'info');

                // 3. サービスを取得
                const service = await server.getPrimaryService(SERVICE_UUID);

                // 4. 特性を取得: DATA (Notify)
                dataCharacteristic = await service.getCharacteristic(DATA_CHAR_UUID);
                
                // 5. DATA特性の通知を有効化
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataNotifications);

                updateStatus('ESP32 受信機に接続完了。メッセージを待機中...', 'success');
                connectButton.classList.add('bg-red-600', 'hover:bg-red-700', 'shadow-red-300');
                connectButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'shadow-indigo-300');
                buttonText.textContent = 'ESP32 から切断';
                
                // 切断イベントリスナーを追加
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
            } catch (error) {
                console.error('BLE接続エラー:', error);
                updateStatus(`接続失敗: ${error.name || error.message}`, 'error');
                bleDevice = null;
                connectButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'shadow-red-300');
                connectButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'shadow-indigo-300');
                buttonText.textContent = 'ESP32 受信機に接続';
            } finally {
                connectButton.disabled = false;
            }
        }
        
        // 切断時イベントハンドラ
        function onDisconnected(event) {
            updateStatus('切断されました。再接続してください。', 'error');
            bleDevice = null;
            connectButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'shadow-red-300');
            connectButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'shadow-indigo-300');
            buttonText.textContent = 'ESP32 受信機に接続';
        }
        
    </script>
</body>
</html>
